<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test WebSocket - Statut Utilisateur</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        h1, h2 {
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input, select, button {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        input, select {
            width: 200px;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            margin-right: 10px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .status-online {
            color: #28a745;
            font-weight: bold;
        }

        .status-offline {
            color: #dc3545;
            font-weight: bold;
        }

        .status-in_game {
            color: #ffc107;
            font-weight: bold;
        }

        .connection-status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }

        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .log {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .user-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .user-card {
            background: #e9ecef;
            padding: 12px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }

        .user-card.online {
            border-left-color: #28a745;
        }

        .user-card.offline {
            border-left-color: #dc3545;
        }

        .user-card.in_game {
            border-left-color: #ffc107;
        }

        .clear-btn {
            background-color: #6c757d;
        }

        .clear-btn:hover {
            background-color: #545b62;
        }
    </style>
</head>
<body>
<h1>üîå Test WebSocket - Statut Utilisateur</h1>

<!-- Configuration -->
<div class="container">
    <h2>‚öôÔ∏è Configuration</h2>
    <div class="form-group">
        <label for="wsUrl">URL WebSocket:</label>
        <input type="text" id="wsUrl" value="ws://localhost:8080/ws/status">
    </div>
    <div class="form-group">
        <label for="currentUserId">ID Utilisateur:</label>
        <input type="text" id="currentUserId" value="user1" placeholder="ex: user1">
    </div>
    <div class="form-group">
        <label for="currentStatus">Statut:</label>
        <select id="currentStatus">
            <option value="online">En ligne</option>
            <option value="offline">Hors ligne</option>
            <option value="in_game">En jeu</option>
        </select>
    </div>

    <div id="connectionStatus" class="connection-status disconnected">
        D√©connect√©
    </div>

    <button onclick="connectWebSocket()">Se connecter</button>
    <button onclick="disconnectWebSocket()" class="clear-btn">Se d√©connecter</button>
    <button onclick="sendStatusUpdate()">Mettre √† jour le statut</button>
    <button onclick="sendHeartbeat()">Envoyer Heartbeat</button>
</div>

<!-- Statut des utilisateurs -->
<div class="container">
    <h2>üë• Statut des Utilisateurs</h2>
    <button onclick="clearUserList()">Effacer la liste</button>
    <div id="userList" class="user-list"></div>
</div>

<!-- Simulateur multi-utilisateurs -->
<div class="container">
    <h2>üé≠ Simulateur Multi-Utilisateurs</h2>
    <div class="form-group">
        <label for="simulateUserId">ID Utilisateur √† simuler:</label>
        <input type="text" id="simulateUserId" placeholder="ex: user2">
    </div>
    <div class="form-group">
        <label for="simulateStatus">Statut √† simuler:</label>
        <select id="simulateStatus">
            <option value="online">En ligne</option>
            <option value="offline">Hors ligne</option>
            <option value="in_game">En jeu</option>
        </select>
    </div>
    <button onclick="simulateUser()">Simuler utilisateur</button>
    <button onclick="createTestUsers()">Cr√©er utilisateurs de test</button>
</div>

<!-- Log des messages -->
<div class="container">
    <h2>üìù Log des Messages</h2>
    <button onclick="clearLog()" class="clear-btn">Effacer le log</button>
    <div id="messageLog" class="log"></div>
</div>

<script>
    let ws = null;
    let userStatuses = new Map();

    // Connexion WebSocket
    function connectWebSocket() {
        const wsUrl = document.getElementById('wsUrl').value;
        const userId = document.getElementById('currentUserId').value;

        if (!userId) {
            alert('Veuillez entrer un ID utilisateur');
            return;
        }

        try {
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                updateConnectionStatus(true);
                logMessage('‚úÖ Connexion WebSocket √©tablie');

                // Envoyer le statut initial
                sendStatusUpdate();
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };

            ws.onclose = () => {
                updateConnectionStatus(false);
                logMessage('‚ùå Connexion WebSocket ferm√©e');
            };

            ws.onerror = (error) => {
                logMessage('üö® Erreur WebSocket: ' + error);
            };

        } catch (error) {
            logMessage('üö® Erreur de connexion: ' + error.message);
        }
    }

    // D√©connexion WebSocket
    function disconnectWebSocket() {
        if (ws) {
            ws.close();
            ws = null;
        }
    }

    // Envoyer mise √† jour de statut
    function sendStatusUpdate() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            alert('WebSocket non connect√©');
            return;
        }

        const userId = document.getElementById('currentUserId').value;
        const status = document.getElementById('currentStatus').value;

        const message = {
            type: 'status_change',
            userId: userId,
            status: status
        };

        ws.send(JSON.stringify(message));
        logMessage('üì§ Statut envoy√©: ' + JSON.stringify(message, null, 2));
    }

    // Envoyer heartbeat
    function sendHeartbeat() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            alert('WebSocket non connect√©');
            return;
        }

        const userId = document.getElementById('currentUserId').value;
        const message = {
            type: 'heartbeat',
            userId: userId
        };

        ws.send(JSON.stringify(message));
        logMessage('üíì Heartbeat envoy√©: ' + JSON.stringify(message, null, 2));
    }

    // G√©rer les messages WebSocket
    function handleWebSocketMessage(data) {
        logMessage('üì• Message re√ßu: ' + JSON.stringify(data, null, 2));

        if (data.type === 'status_update') {
            updateUserStatus(data.userId, data.status);
        }
    }

    // Mettre √† jour le statut d'un utilisateur
    function updateUserStatus(userId, status) {
        userStatuses.set(userId, status);
        updateUserList();
    }

    // Mettre √† jour la liste des utilisateurs
    function updateUserList() {
        const userList = document.getElementById('userList');

        if (userStatuses.size === 0) {
            userList.innerHTML = '<p>Aucun utilisateur connect√©</p>';
            return;
        }

        userList.innerHTML = Array.from(userStatuses.entries()).map(([userId, status]) => `
                <div class="user-card ${status}">
                    <strong>${userId}</strong>
                    <br>
                    <span class="status-${status}">${getStatusLabel(status)}</span>
                    <br>
                    <small>Derni√®re mise √† jour: ${new Date().toLocaleTimeString()}</small>
                </div>
            `).join('');
    }

    // Obtenir le label du statut
    function getStatusLabel(status) {
        const labels = {
            'online': 'En ligne',
            'offline': 'Hors ligne',
            'in_game': 'En jeu'
        };
        return labels[status] || status;
    }

    // Mettre √† jour le statut de connexion
    function updateConnectionStatus(connected) {
        const statusElement = document.getElementById('connectionStatus');
        if (connected) {
            statusElement.textContent = 'Connected';
            statusElement.className = 'connection-status connected';
        } else {
            statusElement.textContent = 'D√©connect√©';
            statusElement.className = 'connection-status disconnected';
        }
    }

    // Logger un message
    function logMessage(message) {
        const log = document.getElementById('messageLog');
        const timestamp = new Date().toLocaleTimeString();
        log.textContent += `[${timestamp}] ${message}\n`;
        log.scrollTop = log.scrollHeight;
    }

    // Effacer le log
    function clearLog() {
        document.getElementById('messageLog').textContent = '';
    }

    // Effacer la liste des utilisateurs
    function clearUserList() {
        userStatuses.clear();
        updateUserList();
    }

    // Simuler un utilisateur
    function simulateUser() {
        const userId = document.getElementById('simulateUserId').value;
        const status = document.getElementById('simulateStatus').value;

        if (!userId) {
            alert('Veuillez entrer un ID utilisateur √† simuler');
            return;
        }

        // Simuler la r√©ception d'un message de statut
        handleWebSocketMessage({
            type: 'status_update',
            userId: userId,
            status: status,
            timestamp: new Date().toISOString()
        });
    }

    // Cr√©er des utilisateurs de test
    function createTestUsers() {
        const testUsers = [
            { userId: 'alice', status: 'online' },
            { userId: 'bob', status: 'in_game' },
            { userId: 'charlie', status: 'offline' },
            { userId: 'diana', status: 'online' }
        ];

        testUsers.forEach(user => {
            handleWebSocketMessage({
                type: 'status_update',
                userId: user.userId,
                status: user.status,
                timestamp: new Date().toISOString()
            });
        });

        logMessage('üë• Utilisateurs de test cr√©√©s');
    }

    // Auto-reconnexion
    setInterval(() => {
        if (ws && ws.readyState === WebSocket.OPEN) {
            sendHeartbeat();
        }
    }, 30000); // Heartbeat toutes les 30 secondes

    // Initialisation
    window.addEventListener('load', () => {
        logMessage('üöÄ Interface de test WebSocket charg√©e');
        updateUserList();
    });
</script>
</body>
</html>
